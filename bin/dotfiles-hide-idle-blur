#!/bin/bash
# Hide the idle blur overlay
set -euo pipefail

source "$(dirname "${BASH_SOURCE[0]}")/lib-dotfiles.sh"

PIDFILE="${XDG_RUNTIME_DIR:-/tmp}/dotfiles-idle-blur.pid"

if [[ ! -f "$PIDFILE" ]]; then
    log_info "Idle blur overlay not running"
    exit 0
fi

PID=$(cat "$PIDFILE")
if ! kill -0 "$PID" 2>/dev/null; then
    log_info "Idle blur overlay not running (stale PID file)"
    rm -f "$PIDFILE"
    exit 0
fi

log_info "Hiding idle blur overlay (PID: $PID)..."
kill "$PID" 2>/dev/null || true

# Wait for process to exit
for i in {1..10}; do
    if ! kill -0 "$PID" 2>/dev/null; then
        break
    fi
    sleep 0.1
done

# Force kill if still running
if kill -0 "$PID" 2>/dev/null; then
    log_warning "Overlay did not exit gracefully, forcing kill"
    kill -9 "$PID" 2>/dev/null || true
fi

rm -f "$PIDFILE"
log_success "Idle blur overlay hidden"
